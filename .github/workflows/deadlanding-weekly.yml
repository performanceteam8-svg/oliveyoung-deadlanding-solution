# ë°ë“œëœë”© ì ê²€: ë§¤ì£¼ ì›”Â·ëª© 6ì‹œ(KST) ì‹¤í–‰, 9ì‹œ(KST) Slack ì•Œë¦¼
# ìˆ˜ë™ ì‹¤í–‰: Actions â†’ "ë°ë“œëœë”© ì£¼ê°„ ì ê²€" â†’ Run workflow (ì ê²€ë§Œ ì‹¤í–‰, Slackì€ 9ì‹œ ìŠ¤ì¼€ì¤„ ì‹œ ì „ì†¡)

name: ë°ë“œëœë”© ì£¼ê°„ ì ê²€

on:
  schedule:
    # 6ì‹œ KST ì ê²€: ì›”Â·ëª© 06:00 KST = ì¼ 21:00 UTC, ìˆ˜ 21:00 UTC
    - cron: '0 21 * * 0'
    - cron: '0 21 * * 3'
    # 9ì‹œ KST ì•Œë¦¼: ì›”Â·ëª© 09:00 KST = ì›” 00:00 UTC, ëª© 00:00 UTC
    - cron: '0 0 * * 1'
    - cron: '0 0 * * 4'
  workflow_dispatch:

jobs:
  # ì›”Â·ëª© 6ì‹œ KST (ë° ìˆ˜ë™ ì‹¤í–‰): ì ê²€ë§Œ ìˆ˜í–‰, ê²°ê³¼ë¥¼ ìºì‹œì— ì €ì¥
  check:
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' || github.event.schedule == '0 21 * * 0' || github.event.schedule == '0 21 * * 3'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set KST date
        id: kst_date
        run: echo "date=$(TZ=Asia/Seoul date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create credentials file
        env:
          CREDENTIALS_JSON: ${{ secrets.CREDENTIALS_JSON }}
        run: |
          mkdir -p credentials
          echo "$CREDENTIALS_JSON" > credentials/service_account.json

      - name: Run Step1 (URL ìˆ˜ì§‘)
        run: python deadlanding_step1_collect_urls.py 2>&1 | tee step1.log

      - name: Run Step2 (URL ì ê²€ ë° ì‹œíŠ¸ ë°˜ì˜)
        run: python deadlanding_step2_check_and_fill.py 2>&1 | tee step2.log

      - name: Write summary for cache
        if: always()
        run: |
          mkdir -p summary
          tail -25 step2.log 2>/dev/null || tail -25 step1.log > summary/body.txt
        continue-on-error: true

      - name: Set status for 9am Slack
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then echo "success" > summary/status.txt; else echo "failure" > summary/status.txt; fi

      - name: Save result to cache (for 9am Slack)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: summary
          key: deadlanding-result-${{ steps.kst_date.outputs.date }}
        continue-on-error: true

  # ì›”Â·ëª© 9ì‹œ KST: ìºì‹œì—ì„œ ë‹¹ì¼ ì ê²€ ê²°ê³¼ ë³µì› í›„ Slack ì „ì†¡
  notify:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && (github.event.schedule == '0 0 * * 1' || github.event.schedule == '0 0 * * 4')
    steps:
      - name: Set KST date
        id: kst_date
        run: echo "date=$(TZ=Asia/Seoul date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Restore cached result
        id: cache
        uses: actions/cache/restore@v4
        with:
          path: summary
          key: deadlanding-result-${{ steps.kst_date.outputs.date }}

      # Slack: í‘œì‹œ ì´ë¦„ "ë°ë“œëœë”© ì ê²€ ê²°ê³¼", ì„±ê³µ/ì‹¤íŒ¨ ë³¸ë¬¸, ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ (Variablesì—ì„œ SPREADSHEET_URL ì§€ì • ê°€ëŠ¥)
      - name: Slack notification (9am KST)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_USERNAME: ${{ vars.SLACK_USERNAME || 'ë°ë“œëœë”© ì ê²€ ê²°ê³¼' }}
          SLACK_BODY_SUCCESS: ${{ vars.SLACK_BODY_SUCCESS || 'ë°ë“œëœë”© ì ê²€ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' }}
          SLACK_BODY_FAILURE: ${{ vars.SLACK_BODY_FAILURE || 'ë°ë“œëœë”© ì ê²€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì›ì¸ì„ í™•ì¸í•´ì£¼ì„¸ìš”.' }}
          SLACK_FALLBACK_MSG: ${{ vars.SLACK_FALLBACK_MSG || 'ì˜¤ëŠ˜ ì˜¤ì „ 6ì‹œ ì ê²€ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.' }}
          SPREADSHEET_URL: ${{ vars.SPREADSHEET_URL || 'https://docs.google.com/spreadsheets/d/12gg9I032qYNdcE_a0d7RB02eguhLKU7mxiAEkJ47RcU/edit' }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then exit 0; fi
          if [ -f summary/body.txt ]; then
            SUMMARY=$(cat summary/body.txt)
            if [ -f summary/status.txt ] && [ "$(cat summary/status.txt)" = "failure" ]; then
              BODY_TEXT="âŒ $SLACK_BODY_FAILURE"
            else
              BODY_TEXT="âœ… $SLACK_BODY_SUCCESS"
            fi
          else
            BODY_TEXT="ğŸ“‹ $SLACK_FALLBACK_MSG"
            SUMMARY=""
          fi
          PAYLOAD=$(jq -n \
            --arg user "$SLACK_USERNAME" \
            --arg body "$BODY_TEXT" \
            --arg url "$SPREADSHEET_URL" \
            --arg sum "$SUMMARY" \
            '{username: $user, blocks: [
              {type: "section", text: {type: "mrkdwn", text: $body}},
              (if $sum != "" then {type: "section", text: {type: "mrkdwn", text: ("```\n" + $sum + "\n```")}} else empty end),
              {type: "actions", elements: [{type: "button", text: {type: "plain_text", text: "ê²°ê³¼ ë³´ê¸°"}, url: $url}]}
            ]}')
          curl -sS -X POST "$SLACK_WEBHOOK_URL" -H 'Content-Type: application/json' -d "$PAYLOAD"
